package transformer

import (
	"fmt"
	"log"
	"strconv"
	"strings"

	"github.com/360EntSecGroup-Skylar/excelize"
	"github.com/abbeydabiri/horizonextractor/loader"
)

func transformTechvulnerabilitybysubsector(xlFile *excelize.File) {

	rows, err := xlFile.GetRows(sheetVulnerabilityscoring)
	if err != nil {
		fmt.Println(err.Error())
		log.Fatal(err.Error())
	}

	var subSectorList []string
	subSectorCellMap := make(map[string]string)
	// tableListTechnologyVulnerabilityBySubSectors := []loader.TechnologyVulnerabilityBySubSectors{}
	for id, cols := range rows {
		cellRow := fmt.Sprintf("%v", id+1)
		if getCellValue(xlFile, sheetVulnerabilityscoring, "A"+cellRow) == "" && id != 4 {
			continue
		}

		if id == 4 {
			iChar := 65
			iPreChar := 0

			for colIndex, colValue := range cols {
				if strings.ToLower(strings.TrimSpace(colValue)) == "" {
					continue
				}

				if colIndex%26 == 0 {
					if iPreChar == 0 {
						iPreChar = 65
					} else {
						iPreChar++
					}
					iChar = 65
				}

				nCurIndex := colIndex % 26

				subSectorKey := strings.ToLower(strings.TrimSpace(colValue))
				subSectorList = append(subSectorList, subSectorKey)

				if iPreChar != 0 {
					subSectorCellMap[subSectorKey] = string(iPreChar) + string(iChar+nCurIndex)
				} else {
					subSectorCellMap[subSectorKey] = string(iChar + nCurIndex)
				}
			}
		}

		if id <= 5 {
			continue
		}

		refKeyTechnology := strings.ToLower(strings.TrimSpace(getCellValue(xlFile, sheetVulnerabilityscoring, "A"+cellRow)))
		for _, refKeySubSector := range subSectorList {
			curRow := loader.TechnologyVulnerabilityBySubSectors{}
			curRow.ImportID = importID
			sChar := subSectorCellMap[refKeySubSector]
			curRow.Score, _ = strconv.Atoi(getCellValue(xlFile, sheetVulnerabilityscoring, sChar+cellRow))
			curRow.SubSectorReferenceID = refSubSectorrefID[refKeySubSector]
			curRow.TechnologyReferenceID = refTechnologyrefID[refKeyTechnology]

			// fmt.Printf("refKeyTechnology: %v -  refKeySubSector: %v - cellRow: %v - cellCol: %v - curRow: %+v \n", refKeyTechnology, refKeySubSector, cellRow, colID, curRow)
			//create Record
			sqlInsert, sqlParams := loader.Insert(&curRow, loader.ToMap(&curRow))
			if err := loader.MSSQL.Get(&curRow.ID, sqlInsert, sqlParams...); err != nil {
				log.Println(err.Error())
			}

			// tableListTechnologyVulnerabilityBySubSectors = append(tableListTechnologyVulnerabilityBySubSectors, curRow)
		}
	}
	// fmt.Printf("tableListTechnologyVulnerabilityBySubSectors: %+v", tableListTechnologyVulnerabilityBySubSectors)

}
